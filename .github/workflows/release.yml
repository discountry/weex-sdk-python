name: Verify Release Tag

on:
  push:
    tags:
      - 'v*.*.*'  # 匹配语义化版本标签，如 v1.0.1

jobs:
  verify:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Extract version from tag
        id: version
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}  # 移除 'v' 前缀
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
      
      - name: Verify version consistency
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PYPROJECT_VERSION=$(grep -E '^version = ' pyproject.toml | cut -d'"' -f2)
          SETUP_VERSION=$(grep -E 'version=' setup.py | cut -d'"' -f2)
          INIT_VERSION=$(grep -E '__version__ = ' weex_sdk/__init__.py | cut -d"'" -f2)
          
          echo "Tag version: $VERSION"
          echo "pyproject.toml version: $PYPROJECT_VERSION"
          echo "setup.py version: $SETUP_VERSION"
          echo "__init__.py version: $INIT_VERSION"
          
          if [ "$VERSION" != "$PYPROJECT_VERSION" ] || [ "$VERSION" != "$SETUP_VERSION" ] || [ "$VERSION" != "$INIT_VERSION" ]; then
            echo "❌ Version mismatch detected!"
            exit 1
          fi
          echo "✅ All versions match"
      
      - name: Build and check package
        run: |
          python -m pip install --upgrade pip
          pip install build twine
          python -m build
          twine check dist/*
