name: Verify Release Tag

on:
  push:
    tags:
      - 'v*.*.*'  # 匹配语义化版本标签，如 v1.0.1

jobs:
  verify:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Extract version from tag
        id: version
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}  # 移除 'v' 前缀
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
      
      - name: Verify version consistency
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # 使用 Python 提取版本号，更可靠
          python3 << 'EOF'
          import re
          import sys
          
          def extract_version(file_path, pattern):
              try:
                  with open(file_path, 'r', encoding='utf-8') as f:
                      content = f.read()
                  match = re.search(pattern, content)
                  if match:
                      return match.group(1)
                  return None
              except Exception as e:
                  print(f"Error reading {file_path}: {e}", file=sys.stderr)
                  return None
          
          pyproject_version = extract_version('pyproject.toml', r'version\s*=\s*["\']([^"\']+)["\']')
          setup_version = extract_version('setup.py', r'version\s*=\s*["\']([^"\']+)["\']')
          init_version = extract_version('weex_sdk/__init__.py', r'__version__\s*=\s*["\']([^"\']+)["\']')
          
          version = "${{ steps.version.outputs.version }}"
          
          print(f"Tag version: {version}")
          print(f"pyproject.toml version: {pyproject_version}")
          print(f"setup.py version: {setup_version}")
          print(f"__init__.py version: __version__ = \"{init_version}\"")
          
          if not pyproject_version or not setup_version or not init_version:
              print("❌ Failed to extract version numbers from files!", file=sys.stderr)
              sys.exit(1)
          
          if version != pyproject_version or version != setup_version or version != init_version:
              print("❌ Version mismatch detected!", file=sys.stderr)
              print(f"   Expected: {version}", file=sys.stderr)
              print(f"   pyproject.toml: {pyproject_version}", file=sys.stderr)
              print(f"   setup.py: {setup_version}", file=sys.stderr)
              print(f"   __init__.py: {init_version}", file=sys.stderr)
              sys.exit(1)
          
          print("✅ All versions match")
          EOF
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Build and check package
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade "setuptools>=77.0.0" build twine "packaging>=24.2" "pkginfo>=1.11"
          python -m build
          twine check dist/*
